pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
#include player.lua
#include boss.lua
#include world.lua
#include control.lua
#include menu.lua
#include transition.lua
#include ui.lua
#include pattern.lua
#include attack.lua
#include collisions.lua
#include particle.lua
#include square_boss.lua
#include circle_boss.lua

function _init()
    -- allows keyboard and mouse
    poke(0x5f2d, 0x1 | 0x2)
    SCREEN = {
        w = 127,
        h = 127,
        hw = 63.5,
        hh = 63.5
    }

    frame_timer = 0
    mode = "menu"

    world = {
        player = nil,
        boss = nil,
        projectiles = {},
        particles = {}
    }
    telegraph_timer = 30 * 2
    shake = 0
    debug_list = {}
    red_frame = 0
    white_frame = 0

    local spacing = SCREEN.w / 3
    menu = {
        p1 = {},
        p2 = {},
        square = { x0 = spacing, y0 = spacing, x1 = spacing + 4, y1 = spacing + 4 },
        circle = { x = spacing * 2, y = spacing + 2, r = 2 },
        t = 0
    }
    select_circle()

    -- while we don't have a menu
    -- set_mode("playing")
end

function _update()
    if mode == "playing" then
        -- projectiles are being deleted in the update_world which isn't ideal
        update_world()
        update_collisions()
        update_control()
    elseif mode == "menu" then
        update_menu()
    end

    transition:update()
    frame_timer += 1
end

function _draw()
    cls()
    if shake > 0 then
        camera(rnd(3) - 1.5, rnd(3) - 1.5)
    else
        camera(0, 0)
    end

    if mode == "playing" then
        draw_world()
        draw_ui()
    elseif mode == "menu" then
        draw_menu()
    end

    if transition.active then transition:draw() end
    if red_frame > 0 then rectfill(0, 0, 127, 127, 8) end
    if white_frame > 0 then rectfill(0, 0, 127, 127, 6) end
    debug()
end

function debug()
    for d in all(debug_list) do
        print(d)
    end
    debug_list = {}
end

function set_mode(new_mode)
    if mode == new_mode then return end

    -- exit logic
    if mode == "playing" then
        -- Cleanup playing mode
    end

    mode = new_mode

    -- startup logic
    if mode == "menu" then
        -- Setup menu mode
    elseif mode == "playing" then
        start_playing()
        -- world.boss = circle_boss:new()
    end
end

function start_playing()
    world = {
        player = player:new(),
        boss = create_boss(next_boss),
        projectiles = {},
        particles = {}
    }

    frame_timer = 0
    shake = 0
end

function create_boss(id)
    if id == "square" then
        return square_boss:new()
    elseif id == "circle" then
        return circle_boss:new()
    end
end

__gfx__
00000000066066000666000000006660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666666600006600000066000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700666666600066660000666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000066666000688006006008860000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000006660000688006006008860000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000600000600006006000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000600006006000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000066660000666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000008808880800088800880888000008080088080808880000008808080888080008000888088000880888088800000000000000000
00000000000000000000000080008000800080008000080000008080808080808080000080008080808080008000800080808000800080800000000000000000
00000000000000000000000088808800800088008000080000008880808080808800000080008880888080008000880080808000880088000000000000000000
00000000000000000000000000808000800080008000080000000080808080808080000080008080808080008000800080808080800080800000000000000000
00000000000000000000000088008880888088800880080000008880880008808080000008808080808088808880888080808880888080800000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000055555000000000000000000000000000000007700888007700000000000000000000000000000000000000
00000000000000000000000000000000000000000055555000000000000000000000000000000007008888800700000000000000000000000000000000000000
00000000000000000000000000000000000000000055555000000000000000000000000000000007008888800700000000000000000000000000000000000000
00000000000000000000000000000000000000000055555000000000000000000000000000000007008888800700000000000000000000000000000000000000
00000000000000000000000000000000000000000055555000000000000000000000000000000007700888007700000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000006660000000000000000000000006660000000000666000000000000000000000000000000000000000
00000000000000000000000000000000000000000000006000000000000000000000000000066000000006600000000000000000000000000000000000000000
00000000000000000000000000000000000000000000006600000000000000000000000000666600000066660000000000000000000000000000000000000000
00000000000000000000000000000000000000000000006000000000000000000000000006880060000600886000000000000000000000000000000000000000
00000000000000000000000000000000000000000000006660000000000000060000000006880060000600886000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000666000000006000060000600006000000000000000000000000000000000000000
00000000000000000000000000000000000000000006606600666000000000060000000006000060000600006000000000000000000000000000000000000000
00000000000000000000000000000000000000000060006060600000000000000000000000666600000066660000000000000000000000000000000000000000
00000000000000000000000000000000000000000066606060660000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000606060600000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000066006660600000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

__sfx__
000800000f0500f05028050280501a0500e0501e00019000120000f0001c00015000100000d0001a0001700015000100000300023000260002a0002c0002f0002400026000290002c0002f00031000370003b000
0002000010010100101001010000000001000022000190000e0000600000000140000f0000b000070000100000000000000800001000000000000000000000000000000000000000000000000000000000000000
